# .github/workflows/deploy-backend.yml
name: Deploy Backend to Unraid

on:
  push:
    branches: [ "main" ]
    # Only trigger on backend-related file changes
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    # Targets your self-hosted runner on Unraid
    runs-on: self-hosted

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Inject Secrets
      # ---------------------------------------------------------
      - name: Create .env file from GitHub Secret
        run: |
          echo "${{ secrets.PROD_ENV_FILE }}" > .env
          echo "âœ… .env file created from secret."

      # ---------------------------------------------------------
      # Deployment
      # ---------------------------------------------------------
      - name: Build and Start Container
        run: |
          echo "ðŸš€ Starting Docker Compose Build..."
          
          # 1. --build: Forces a rebuild to include new code
          # 2. -d: Detached mode
          # 3. --remove-orphans: Clean up
          docker compose up -d --build --remove-orphans
          
          echo "ðŸ§¹ Pruning old images..."
          docker image prune -f
          
          echo "âœ… Backend deployment to Unraid complete."